version: 2
jobs:
  build:
    working_directory: ~/tmp
    docker:
      - image: circleci/node:7
        auth: 
        username: _json_key
        password: $GOOGLE_AUTH 
    steps:
      - checkout
      - run: npm install
      - run: npm test
      - run: curl https://dl.google.com/dl/cloudsdk/channels/rapid/install_google_cloud_sdk.bash -o gcloud_install.sh && sudo sh gcloud_install.sh --disable-prompts --install-dir="/bin"
      - run: 
          name: Dump Google Cloud Credentials to file
          command: echo ${GOOGLE_AUTH} > ${HOME}/gcp-key.json && cat ${HOME}/gcp-key.json

      - run: |
        gcloud auth activate-service-account --key-file ${HOME}/gcp-key.json
        gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
        gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
        gcloud --quiet container clusters get-credentials ${GOOGLE_CLUSTER_NAME}
      - run: sudo /bin/google-cloud-sdk/bin/gcloud docker -- push eu.gcr.io/entur-1287/hello-ci
